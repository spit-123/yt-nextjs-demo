<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>

    <!-- Handlers for Node.js / Next.js -->
    <handlers>
      <add name="iisnode" path="server.js" verb="*" modules="iisnode" />
    </handlers>

    <!-- Allow large request bodies (POST/PUT with JWT or files) -->
    <security>
      <requestFiltering>
        <requestLimits maxAllowedContentLength="52428800" /> <!-- 50 MB -->
      </requestFiltering>
    </security>

    <!-- URL Rewrite Rules -->
    <rewrite>
      <rules>

        <!-- 1. Redirect HTTP to HTTPS -->
        <rule name="Redirect to HTTPS" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" ignoreCase="true" />
          </conditions>
          <action type="Redirect" url="https://spit.norbikhr.in/{R:1}" redirectType="Permanent" />
        </rule>

        <!-- 2. Reverse proxy to NestJS -->
        <rule name="ReverseProxyToNestJS" stopProcessing="true">
          <match url="^api/(.*)" />
          <action type="Rewrite" url="http://localhost:8012/{R:1}" appendQueryString="true" />
          <serverVariables>
            <set name="HTTP_AUTHORIZATION" value="{HTTP_AUTHORIZATION}" />
          </serverVariables>
        </rule>

        <!-- 3. Next.js dynamic content -->
        <rule name="DynamicContent" stopProcessing="true">
          <conditions>
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="True" />
          </conditions>
          <action type="Rewrite" url="server.js" />
        </rule>

      </rules>
    </rewrite>

    <!-- ARR Reverse Proxy Settings -->
    <proxy>
      <reverseProxy enabled="true" />
    </proxy>
        <httpErrors errorMode="Detailed" />
        <defaultDocument>
            <files>
                <add value="server.js" />
            </files>
        </defaultDocument>

  </system.webServer>
</configuration>
